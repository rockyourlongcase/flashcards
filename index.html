<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Long Case Flashcards ‚Äî DARNFASTIF</title>
<link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,400;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --teal: #5CB8A5;
  --teal-light: #E8F5F1;
  --teal-dark: #3D9B89;
  --teal-bg: #f8fffe;
  --gold: #C4960C;
  --gold-light: #FFF8E7;
  --gold-bg: #B8930F;
  --bg: #FAFBFC;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Libre Franklin', system-ui, sans-serif;
  background: var(--bg);
  color: #333;
  -webkit-tap-highlight-color: transparent;
}
#app {
  max-width: 700px;
  margin: 0 auto;
  padding: 0 16px;
  min-height: 100vh;
  position: relative;
}
.loading { text-align: center; padding: 80px 20px; color: #999; font-size: 16px; }

/* HOME */
.home-header { text-align: center; padding-top: 32px; margin-bottom: 32px; }
.stars { font-size: 24px; letter-spacing: 6px; color: var(--gold); margin-bottom: 8px; }
.home-title { font-size: 32px; font-weight: 800; color: #1a1a1a; letter-spacing: -0.5px; margin-bottom: 4px; }
.home-subtitle { font-size: 18px; font-style: italic; color: var(--teal); font-weight: 600; margin-bottom: 12px; }
.home-tagline { font-style: italic; color: #555; font-size: 15px; line-height: 1.5; margin-bottom: 8px; }
.home-credit { color: #666; font-size: 14px; line-height: 1.5; }
.home-credit a { color: var(--teal); font-weight: 600; text-decoration: none; }
.key-bar { text-align: center; border-top: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; padding: 12px 0; margin-bottom: 8px; font-size: 13px; color: #777; }
.key-label { letter-spacing: 2px; font-size: 11px; font-weight: 600; color: #aaa; }
.key-items { margin-top: 6px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
.install-toggle { text-align: center; margin-bottom: 24px; font-size: 14px; cursor: pointer; color: var(--teal); font-weight: 600; }
.install-box { margin-top: 8px; background: #fff; border: 1px solid #e8e8e8; border-radius: 10px; padding: 12px 16px; text-align: left; font-size: 13px; color: #555; line-height: 1.6; }
.spec-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding-bottom: 100px; }
.spec-card {
  background: #fff; border-radius: 14px; padding: 20px 8px 16px; text-align: center;
  cursor: pointer; box-shadow: 0 1px 4px rgba(0,0,0,0.06); border: 1px solid #f0f0f0;
  transition: transform 0.15s, box-shadow 0.15s;
}
.spec-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.spec-card.empty { opacity: 0.5; cursor: default; }
.spec-card.empty:hover { transform: none; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
.spec-icon { width: 52px; height: 52px; border-radius: 14px; background: var(--teal); display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; }
.spec-name { font-size: 13px; font-weight: 600; color: #333; line-height: 1.3; }
.coming-soon { font-size: 10px; color: #aaa; margin-top: 4px; }

/* SPECIALTY PAGE */
.back-link { color: var(--teal); font-size: 14px; cursor: pointer; font-weight: 600; margin-bottom: 16px; padding-top: 20px; }
.spec-header { display: flex; align-items: center; gap: 14px; margin-bottom: 24px; }
.spec-header h2 { font-size: 24px; font-weight: 700; color: #1a1a1a; }
.cond-list { display: flex; flex-direction: column; gap: 2px; padding-bottom: 100px; }
.cond-item {
  background: #fff; border-radius: 12px; padding: 18px 20px; cursor: pointer;
  font-size: 16px; font-weight: 500; color: #222;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04); border: 1px solid #f0f0f0;
  transition: background 0.15s;
}
.cond-item:hover { background: var(--teal-bg); }

/* CONDITION PAGE */
.cond-title { margin: 0 0 14px; font-size: 24px; font-weight: 700; color: #1a1a1a; }
.btn-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
.btn { border-radius: 20px; padding: 7px 16px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1.5px solid; font-family: inherit; }
.btn-teal-outline { background: transparent; border-color: var(--teal); color: var(--teal); }
.btn-teal { background: var(--teal); border-color: var(--teal); color: #fff; }
.btn-gold-outline { background: transparent; border-color: var(--gold); color: var(--gold); }
.btn-grey-outline { background: transparent; border-color: #ccc; color: #666; }
.btn-practice { background: transparent; border-color: #888; color: #666; margin-left: auto; }

/* SECTIONS */
.sections { display: flex; flex-direction: column; gap: 3px; padding-bottom: 100px; }
.section-wrapper { position: relative; }
.section-wrapper.indent-1 { margin-left: 28px; }
.section-wrapper.indent-half { margin-left: 14px; }
.connect-line { position: absolute; left: -14px; top: 0; bottom: 0; width: 3px; background: var(--teal); border-radius: 2px; opacity: 0.7; }
.section-header {
  background: #fff; border-radius: 10px; padding: 12px 16px; display: flex; align-items: center; gap: 10px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04); border: 1px solid #f0f0f0; transition: background 0.15s;
  user-select: none;
}
.section-header.active { cursor: pointer; }
.section-header.active:hover { background: var(--teal-bg); }
.section-header.expanded { background: var(--teal-bg); }
.section-header.inactive { opacity: 0.4; }
.section-letter {
  width: 30px; height: 30px; border-radius: 8px; color: #fff;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 700; flex-shrink: 0;
}
.section-letter.active { background: var(--teal); }
.section-letter.inactive { background: #ccc; }
.section-label { font-size: 16px; font-weight: 600; }
.section-label .first-letter { color: var(--teal); }
.section-label.inactive { color: #999; }
.section-label.inactive .first-letter { color: #bbb; }
.section-label.no-letter { font-size: 15px; }
.section-icon { font-size: 16px; cursor: pointer; flex-shrink: 0; position: relative; }

/* SECTION CONTENT */
.section-content {
  background: #fff; border-radius: 0 0 10px 10px; padding: 8px 16px 12px;
  margin-top: -2px; border: 1px solid #f0f0f0; border-top: none;
}
.content-category {
  background: var(--teal-light); border-left: 3px solid var(--teal);
  padding: 8px 12px; margin-top: 10px; margin-bottom: 6px;
  font-size: 14px; font-weight: 600; color: #333; border-radius: 0 6px 6px 0;
}
.content-subheading { font-size: 14px; font-weight: 700; color: #333; margin-top: 10px; margin-bottom: 4px; padding: 0 4px; }
.content-italic { font-size: 14px; font-style: italic; color: #666; padding: 4px; }
.content-row {
  display: flex; align-items: flex-start; gap: 10px; padding: 8px 4px;
  border-bottom: 1px solid #f8f8f8; cursor: pointer; transition: background 0.15s;
  user-select: none; border-radius: 4px;
}
.content-row.checked { background: var(--teal-light); }
.content-row.bulleted { padding-left: 20px; }
.bullet { color: var(--teal); font-size: 18px; line-height: 1; margin-top: -1px; }
.checkbox {
  width: 22px; height: 22px; border-radius: 6px; border: 2px solid #d0d0d0;
  background: #fff; flex-shrink: 0; display: flex; align-items: center;
  justify-content: center; margin-top: 1px; transition: all 0.15s;
}
.checkbox.checked { border-color: var(--teal); background: var(--teal); }
.checkbox.checked::after { content: '‚úì'; color: #fff; font-size: 14px; font-weight: 700; }
.content-text { font-size: 14px; color: #333; line-height: 1.5; flex: 1; }
.content-text.bold { font-weight: 700; }
.content-text.checked { font-weight: 600; }
.inline-icon { cursor: pointer; font-size: 16px; flex-shrink: 0; margin-top: 1px; position: relative; }

/* TOOLTIP */
.tooltip {
  position: fixed; background: #2a2a2a; color: #fff; border-radius: 10px;
  padding: 10px 14px; max-width: 280px; font-size: 13px; line-height: 1.5;
  z-index: 200; box-shadow: 0 4px 20px rgba(0,0,0,0.3); pointer-events: none;
}
.tooltip-label { font-size: 12px; font-weight: 700; margin-bottom: 4px; }
.tooltip-label.synthesis { color: var(--gold); }
.tooltip-label.info { color: var(--gold); }
.tooltip-label.course { color: var(--teal); }
.tooltip a { color: var(--teal); text-decoration: underline; pointer-events: auto; }

/* FLOATING BUTTON */
.fab {
  position: fixed; bottom: 24px; right: 24px; width: 52px; height: 52px;
  border-radius: 50%; background: #2D5A4E; color: #fff; display: flex;
  align-items: center; justify-content: center; font-size: 20px;
  cursor: pointer; box-shadow: 0 4px 16px rgba(0,0,0,0.2); z-index: 100;
  transition: transform 0.15s; border: none;
}
.fab:hover { transform: scale(1.1); }
.fab-badge {
  position: absolute; top: -4px; right: -4px; background: #E74C3C; color: #fff;
  border-radius: 50%; width: 20px; height: 20px; font-size: 11px; font-weight: 700;
  display: flex; align-items: center; justify-content: center;
}

/* MODAL */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300;
  display: flex; align-items: center; justify-content: center; padding: 20px;
}
.modal {
  background: #fff; border-radius: 18px; padding: 24px; max-width: 420px;
  width: 100%; max-height: 80vh; overflow: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.2);
}
.modal h3 { font-size: 20px; font-weight: 700; margin: 0 0 14px; }
.modal h3.teal { color: var(--teal); }
.modal h3.gold { color: var(--gold); }
.modal-item { background: #f8f8f8; border-radius: 10px; padding: 12px 16px; font-size: 15px; color: #333; margin-bottom: 6px; }
.modal-item.teal { background: var(--teal-light); color: var(--teal-dark); font-size: 14px; line-height: 1.4; }
.modal-item.gold { background: var(--gold-light); font-size: 14px; color: #444; line-height: 1.6; }
.modal-close { width: 100%; margin-top: 20px; border: none; border-radius: 12px; padding: 12px; font-size: 15px; font-weight: 600; cursor: pointer; color: #fff; font-family: inherit; }
.modal-close.teal { background: var(--teal); }
.modal-close.gold { background: var(--gold-bg); }

/* TRACKER */
.tracker-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.tracker-header h3 { font-size: 22px; font-weight: 700; color: #1a1a1a; }
.tracker-close { font-size: 24px; cursor: pointer; color: #999; padding: 0 4px; background: none; border: none; }
.tracker-stats { display: flex; gap: 12px; margin-bottom: 12px; }
.tracker-stat { background: #2D5A4E; color: #fff; border-radius: 10px; padding: 10px 16px; text-align: center; flex: 1; }
.tracker-stat-num { font-size: 24px; font-weight: 700; }
.tracker-stat-label { font-size: 11px; opacity: 0.8; font-weight: 600; }
.tracker-progress { flex: 2; display: flex; flex-direction: column; justify-content: center; }
.tracker-progress-label { font-size: 13px; font-weight: 600; color: #555; margin-bottom: 4px; }
.tracker-progress-bar { background: #e8e8e8; border-radius: 6px; height: 10px; overflow: hidden; }
.tracker-progress-fill { background: var(--teal); height: 100%; border-radius: 6px; transition: width 0.3s; }
.tracker-msg { background: #E8F5E9; border-radius: 10px; padding: 10px 14px; font-size: 13px; color: #2E7D32; font-weight: 600; margin-bottom: 14px; }
.tracker-spec-label { font-size: 11px; font-weight: 700; color: var(--teal); letter-spacing: 1.5px; padding: 12px 0 4px; border-bottom: 1px solid #f0f0f0; }
.tracker-cond { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f8f8f8; gap: 12px; }
.tracker-circle {
  width: 36px; height: 36px; border-radius: 50%; border: 2.5px solid;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700; flex-shrink: 0; position: relative;
}
.tracker-cond-info { flex: 1; }
.tracker-cond-name { font-size: 14px; font-weight: 600; color: #222; }
.tracker-cond-status { font-size: 12px; font-weight: 600; }
.tracker-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.tracker-reset { text-align: center; margin-top: 16px; font-size: 13px; color: #bbb; cursor: pointer; background: none; border: none; font-family: inherit; }
.tracker-list { max-height: 400px; overflow: auto; }

@media (max-width: 400px) {
  .spec-grid { grid-template-columns: repeat(2, 1fr); }
  .btn-bar { gap: 6px; }
  .btn { padding: 6px 12px; font-size: 12px; }
}
</style>
</head>
<body>

<div id="app">
  <div class="loading" id="loading">Loading flashcards...</div>
</div>

<script>
// ============================================================
// SVG Icons
// ============================================================
const ICONS = {
  cardiology: '<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.42 4.58a5.4 5.4 0 0 0-7.65 0L12 5.34l-.77-.76a5.4 5.4 0 0 0-7.65 0 5.4 5.4 0 0 0 0 7.65L12 20.65l8.42-8.42a5.4 5.4 0 0 0 0-7.65z"/></svg>',
  endocrinology: '<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>',
  gastroenterology: '<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4c0 0 2 0 2 3v4c0 2-1 3-3 3h-2c-1 0-2 1-2 2v1c0 1.5-1 3-3 3s-3-1.5-3-3v-1"/><path d="M8 4v5c0 2 1 3 2 3"/></svg>',
  haematology: '<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>',
  'infectious-diseases': '<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/><circle cx="12" cy="12" r="8"/></svg>',
  nephrology: '<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12c0-4 2-8 5-8 2 0 3 2 3 4s-1 4-3 4c-1 0-2-.5-2-2"/><path d="M20 12c0-4-2-8-5-8-2 0-3 2-3 4s1 4 3 4c1 0 2-.5 2-2"/><path d="M4 12c0 4 2 8 5 8 2 0 3-2 3-4"/><path d="M20 12c0 4-2 8-5 8-2 0-3-2-3-4"/></svg>',
  neurology: '<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C9 2 7 4 7 6c-2 0-4 2-4 4.5S5 15 7 15c0 2 1.5 4 3.5 4.5L12 20"/><path d="M12 2c3 0 5 2 5 4 2 0 4 2 4 4.5S19 15 17 15c0 2-1.5 4-3.5 4.5L12 20"/><path d="M12 2v18"/><path d="M7 9c2 0 5 1 5 3"/><path d="M17 9c-2 0-5 1-5 3"/></svg>',
  oncology: '<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 21h12"/><path d="M9 21v-3h6v3"/><path d="M12 18v-4"/><circle cx="12" cy="10" r="4"/><path d="M14.5 7.5l2-2"/><path d="M15.5 4.5l2 2"/><path d="M12 6V2"/></svg>',
  respiratory: '<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 4v8"/><path d="M12 12c-2 0-3 1-4 3-1 2-2 4-5 4"/><path d="M12 12c2 0 3 1 4 3 1 2 2 4 5 4"/><path d="M7 12c-2 0-4 2-4 5s2 3 4 3c1.5 0 2.5-.5 3-1"/><path d="M17 12c2 0 4 2 4 5s-2 3-4 3c-1.5 0-2.5-.5-3-1"/></svg>',
  rheumatology: '<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 2v6c0 1-.5 2-2 2.5"/><path d="M14 2v6c0 1 .5 2 2 2.5"/><ellipse cx="12" cy="12" rx="4" ry="2.5"/><path d="M10 14.5c-1.5.5-2 1.5-2 2.5v5"/><path d="M14 14.5c1.5.5 2 1.5 2 2.5v5"/></svg>',
  transplant: '<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="3"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>',
  miscellaneous: '<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="12" cy="12" r="3"/></svg>'
};

// ============================================================
// DARNFASTIF Section Config
// ============================================================
const SECTION_CONFIG = [
  { key: 'diagnosis', letter: 'D', label: 'Diagnosis', indent: 0, group: null },
  { key: 'aetiology', letter: 'A', label: 'Aetiology', indent: 0, group: null },
  { key: 'riskFactors', letter: 'R', label: 'Risk Factors', indent: 0, group: null },
  { key: 'progress', letter: 'P', label: 'Progress', indent: 1, group: 'rp' },
  { key: 'now', letter: 'N', label: 'Now', indent: 0, group: null },
  { key: 'management', letter: null, label: 'Management', indent: 0, group: 'now-sub' },
  { key: 'complications', letter: null, label: 'Complications', indent: 0, group: 'now-sub' },
  { key: 'function', letter: 'F', label: 'Function', indent: 1, group: 'fasti' },
  { key: 'adherence', letter: 'A', label: 'Adherence', indent: 1, group: 'fasti' },
  { key: 'symptoms', letter: 'S', label: 'Symptoms', indent: 1, group: 'fasti' },
  { key: 'targets', letter: 'T', label: 'Targets', indent: 1, group: 'fasti' },
  { key: 'impact', letter: 'I', label: 'Impact', indent: 1, group: 'fasti' },
  { key: 'future', letter: 'F', label: 'Future', indent: 0, group: null }
];

// ============================================================
// State
// ============================================================
let DATA = [];
let state = {
  view: 'home',
  specialty: null,
  condition: null,
  expanded: {},
  checked: {},
  modal: null,
  tooltip: null,
  installOpen: false,
  practice: {}
};

// ============================================================
// Storage
// ============================================================
function loadPractice() {
  try {
    const d = localStorage.getItem('lc-practice');
    if (d) state.practice = JSON.parse(d);
  } catch(e) {}
}
function savePractice() {
  try { localStorage.setItem('lc-practice', JSON.stringify(state.practice)); } catch(e) {}
}

// ============================================================
// Load Data
// ============================================================
async function loadData() {
  try {
    const resp = await fetch('data.json');
    DATA = await resp.json();
  } catch(e) {
    document.getElementById('loading').textContent = 'Error loading data. Make sure data.json is in the same folder.';
    return;
  }
  loadPractice();
  render();
}

// ============================================================
// Navigation
// ============================================================
function navigate(view, spec, cond) {
  state.view = view;
  state.specialty = spec;
  state.condition = cond;
  state.expanded = {};
  state.modal = null;
  state.tooltip = null;
  render();
  window.scrollTo(0, 0);
}

// ============================================================
// Render
// ============================================================
function render() {
  const app = document.getElementById('app');
  let html = '';

  if (state.view === 'home') html = renderHome();
  else if (state.view === 'specialty') html = renderSpecialty();
  else if (state.view === 'condition') html = renderCondition();

  // Floating tracker button
  const allConds = DATA.flatMap(s => s.conditions);
  const practiced = allConds.filter(c => (state.practice[c.id]?.count || 0) > 0).length;
  html += `<button class="fab" onclick="showModal('tracker')">üìä${practiced > 0 ? `<span class="fab-badge">${practiced}</span>` : ''}</button>`;

  app.innerHTML = html;

  // Modal
  if (state.modal) renderModal();
  // Tooltip
  if (state.tooltip) renderTooltip();
}

function renderHome() {
  let specCards = DATA.map(s => {
    const empty = s.conditions.length === 0;
    const icon = ICONS[s.id] || ICONS.miscellaneous;
    return `<div class="spec-card${empty ? ' empty' : ''}" ${empty ? '' : `onclick="navigate('specialty',${DATA.indexOf(s)})"`}>
      <div class="spec-icon">${icon}</div>
      <div class="spec-name">${s.name}</div>
      ${empty ? '<div class="coming-soon">Coming soon</div>' : ''}
    </div>`;
  }).join('');

  return `
    <div class="home-header">
      <div class="stars">‚òÖ ‚òÖ ‚òÖ ‚òÖ ‚òÖ</div>
      <div class="home-title">Long Case Flashcards</div>
      <div class="home-subtitle">DARNFASTIF Framework</div>
      <p class="home-tagline">Take the history the way you will present the history</p>
      <p class="home-credit">A companion resource to the <a href="#">Rock Your Long Case</a> tutorials by Kristeen Barker.</p>
    </div>
    <div class="key-bar">
      <div class="key-label">KEY</div>
      <div class="key-items">
        <span>üîó Synthesis tips</span>
        <span>üí° General tips</span>
        <span>üìö RYLC lessons</span>
      </div>
    </div>
    <div class="install-toggle" onclick="toggleInstall()">
      üì± Install as App on Your Phone ${state.installOpen ? '‚ñ≤' : '‚ñº'}
    </div>
    ${state.installOpen ? `<div class="install-box">
      <strong>iPhone / iPad</strong><br>Tap the Share button ‚éã ‚Üí "Add to Home Screen"<br><br>
      <strong>Android</strong><br>Tap the menu ‚ãÆ ‚Üí "Add to Home screen" or "Install app"
    </div>` : ''}
    <div class="spec-grid">${specCards}</div>`;
}

function renderSpecialty() {
  const s = DATA[state.specialty];
  const icon = ICONS[s.id] || ICONS.miscellaneous;
  let items = s.conditions.map((c, i) =>
    `<div class="cond-item" onclick="navigate('condition',${state.specialty},${i})">${c.name}</div>`
  ).join('');

  return `
    <div class="back-link" onclick="navigate('home')">‚Üê Back</div>
    <div class="spec-header">
      <div class="spec-icon">${icon}</div>
      <h2>${s.name}</h2>
    </div>
    <div class="cond-list">${items}</div>`;
}

function renderCondition() {
  const s = DATA[state.specialty];
  const c = s.conditions[state.condition];

  let btns = '';
  if (c.headingModifiers?.length) btns += `<button class="btn btn-teal-outline" onclick="showModal('modifiers')">Heading Modifiers</button>`;
  if (c.resources?.length) btns += `<button class="btn btn-teal" onclick="showModal('resources')">üìö Resources</button>`;
  if (c.tips) btns += `<button class="btn btn-gold-outline" onclick="showModal('tips')">üí° Tips</button>`;
  
  const pc = state.practice[c.id]?.count || 0;
  btns += `<button class="btn btn-practice" onclick="logPractice('${c.id}')">‚úì Practised${pc ? ` (${pc})` : ''}</button>`;
  btns += `<button class="btn btn-grey-outline" onclick="expandAll()">‚äû Expand All</button>`;

  let sections = SECTION_CONFIG.map(cfg => {
    const sd = c.sections[cfg.key] || { active: false, items: [] };
    const isActive = sd.active;
    const isExpanded = state.expanded[cfg.key];
    const hasLetter = cfg.letter !== null;
    const showLine = cfg.group === 'rp' || cfg.group === 'fasti';
    const indentClass = cfg.indent === 1 ? ' indent-1' : (cfg.group === 'now-sub' ? ' indent-half' : '');

    // Section-level icons
    let sectionIconsHtml = '';
    if (sd.sectionIcons?.length) {
      sectionIconsHtml = sd.sectionIcons.map((ic, ii) => {
        const emoji = ic.type === 'synthesis' ? 'üîó' : ic.type === 'course' ? 'üìö' : 'üí°';
        return `<span class="section-icon" onmouseenter="showSectionTooltip(event,'${ic.type}',${JSON.stringify(ic.tip || ic.ref || '').replace(/'/g, "\\'")})" onmouseleave="hideTooltip()" ontouchstart="toggleSectionTooltip(event,'${ic.type}',${JSON.stringify(ic.tip || ic.ref || '').replace(/'/g, "\\'")})">${emoji}</span>`;
      }).join('');
    }

    let headerClass = `section-header${isActive ? ' active' : ' inactive'}${isExpanded ? ' expanded' : ''}`;
    let letterHtml = hasLetter ? `<div class="section-letter ${isActive ? 'active' : 'inactive'}">${cfg.letter}</div>` : '';
    let labelClass = `section-label${!isActive ? ' inactive' : ''}${!hasLetter ? ' no-letter' : ''}`;
    let labelHtml = hasLetter
      ? `<span class="${labelClass}"><span class="first-letter">${cfg.label[0]}</span>${cfg.label.slice(1)}</span>`
      : `<span class="${labelClass}">${cfg.label}</span>`;

    let contentHtml = '';
    if (isExpanded && sd.items?.length) {
      contentHtml = `<div class="section-content">${renderItems(c.id, cfg.key, sd.items)}</div>`;
    }

    return `<div class="section-wrapper${indentClass}">
      ${showLine ? '<div class="connect-line"></div>' : ''}
      <div class="${headerClass}" ${isActive ? `onclick="toggleSection('${cfg.key}')"` : ''}>
        ${letterHtml}${labelHtml}${sectionIconsHtml}
      </div>
      ${contentHtml}
    </div>`;
  }).join('');

  return `
    <div class="back-link" onclick="navigate('specialty',${state.specialty})">‚Üê ${s.name}</div>
    <h2 class="cond-title">${c.name}</h2>
    <div class="btn-bar">${btns}</div>
    <div class="sections">${sections}</div>`;
}

function renderItems(condId, sectionKey, items) {
  return items.map((item, idx) => {
    if (item.type === 'category') {
      return `<div class="content-category">${esc(item.text)}</div>`;
    }
    if (item.type === 'subheading') {
      return `<div class="content-subheading">${esc(item.text)}</div>`;
    }
    if (item.type === 'italic') {
      return `<div class="content-italic">${esc(item.text)}</div>`;
    }

    const checkKey = `${condId}-${sectionKey}-${idx}`;
    const isChecked = state.checked[checkKey];
    const isBullet = item.type === 'checkbox-bullet';
    const isBold = item.bold;

    let iconsHtml = '';
    if (item.icons?.length) {
      iconsHtml = item.icons.map(ic => {
        const emoji = ic.type === 'synthesis' ? 'üîó' : ic.type === 'course' ? 'üìö' : 'üí°';
        const content = ic.tip || ic.ref || '';
        const safeContent = content.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/\n/g,'\\n');
        return `<span class="inline-icon" onclick="event.stopPropagation()" onmouseenter="showItemTooltip(event,'${ic.type}','${safeContent}')" onmouseleave="hideTooltip()" ontouchstart="toggleItemTooltip(event,'${ic.type}','${safeContent}')">${emoji}</span>`;
      }).join('');
    }

    return `<div class="content-row${isChecked ? ' checked' : ''}${isBullet ? ' bulleted' : ''}" onclick="toggleCheck('${checkKey}')">
      ${isBullet ? '<span class="bullet">‚Ä¢</span>' : ''}
      <div class="checkbox${isChecked ? ' checked' : ''}"></div>
      <span class="content-text${isBold ? ' bold' : ''}${isChecked ? ' checked' : ''}">${esc(item.text)}</span>
      ${iconsHtml}
    </div>`;
  }).join('');
}

// ============================================================
// Modal
// ============================================================
function renderModal() {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = (e) => { if (e.target === overlay) closeModal(); };

  const modal = document.createElement('div');
  modal.className = 'modal';

  if (state.modal === 'modifiers') {
    const c = DATA[state.specialty].conditions[state.condition];
    modal.innerHTML = `<h3 class="teal" style="font-style:italic">Heading Modifiers</h3>
      ${c.headingModifiers.map(m => `<div class="modal-item">${esc(m)}</div>`).join('')}
      <button class="modal-close teal" onclick="closeModal()">Close</button>`;
  }
  else if (state.modal === 'resources') {
    const c = DATA[state.specialty].conditions[state.condition];
    modal.innerHTML = `<h3 class="teal">üìö Resources</h3>
      <div style="font-size:13px;font-weight:600;color:#666;margin-bottom:14px">Course References</div>
      ${c.resources.map(r => {
        if (r.includes('http')) {
          const parts = r.split('|');
          const title = parts.length > 1 ? parts[0] : r;
          const url = parts.length > 1 ? parts[1] : r;
          return `<a href="${esc(url)}" target="_blank" style="text-decoration:none"><div class="modal-item teal">üìö ${esc(title)}</div></a>`;
        }
        return `<div class="modal-item teal">üìö ${esc(r)}</div>`;
      }).join('')}
      <button class="modal-close teal" onclick="closeModal()">Close</button>`;
  }
  else if (state.modal === 'tips') {
    const c = DATA[state.specialty].conditions[state.condition];
    modal.innerHTML = `<h3 class="gold">üí° Tips</h3>
      <div class="modal-item gold">${esc(c.tips).replace(/\\n/g, '<br>')}</div>
      <button class="modal-close gold" onclick="closeModal()">Close</button>`;
  }
  else if (state.modal === 'tracker') {
    modal.innerHTML = renderTracker();
  }

  overlay.appendChild(modal);
  document.body.appendChild(overlay);
}

function renderTracker() {
  const allConds = DATA.flatMap(s => s.conditions.map(c => ({...c, specName: s.name, specId: s.id})));
  const totalSessions = Object.values(state.practice).reduce((s,d) => s + (d.count||0), 0);
  const totalMastered = allConds.filter(c => (state.practice[c.id]?.count||0) >= 10).length;
  const totalPracticed = allConds.filter(c => (state.practice[c.id]?.count||0) > 0).length;
  const pct = allConds.length > 0 ? Math.round((totalMastered / allConds.length) * 100) : 0;

  let condList = DATA.filter(s => s.conditions.length > 0).map(s => {
    let items = s.conditions.map(c => {
      const count = state.practice[c.id]?.count || 0;
      const mastered = count >= 10;
      const color = mastered ? '#2D5A4E' : count > 0 ? '#C4960C' : '#E74C3C';
      const status = mastered ? '‚úì Mastered' : count > 0 ? `${count}/10` : 'Not yet';
      return `<div class="tracker-cond">
        <div class="tracker-circle" style="border-color:${color};color:${color}">${count}</div>
        <div class="tracker-cond-info">
          <div class="tracker-cond-name">${esc(c.name)}</div>
          <div class="tracker-cond-status" style="color:${color}">${status}</div>
        </div>
        <div class="tracker-dot" style="background:${color}"></div>
      </div>`;
    }).join('');
    return `<div class="tracker-spec-label">${s.name.toUpperCase()}</div>${items}`;
  }).join('');

  let msg = '';
  if (totalSessions > 0) {
    msg = totalMastered > 0
      ? `üí™ Great progress! You've mastered ${totalMastered} condition${totalMastered>1?'s':''} and practised ${totalPracticed}. Keep going!`
      : `üí™ You've started practising ${totalPracticed} condition${totalPracticed>1?'s':''}. Aim for 10 each to master them!`;
  }

  return `
    <div class="tracker-header"><h3>Practice Tracker</h3><button class="tracker-close" onclick="closeModal()">‚úï</button></div>
    <div class="tracker-stats">
      <div class="tracker-stat"><div class="tracker-stat-num">${totalSessions}</div><div class="tracker-stat-label">SESSIONS</div></div>
      <div class="tracker-stat"><div class="tracker-stat-num">${totalMastered}</div><div class="tracker-stat-label">MASTERED</div></div>
      <div class="tracker-progress"><div class="tracker-progress-label">Overall ${pct}%</div><div class="tracker-progress-bar"><div class="tracker-progress-fill" style="width:${pct}%"></div></div></div>
    </div>
    ${msg ? `<div class="tracker-msg">${msg}</div>` : ''}
    <div class="tracker-list">${condList}</div>
    ${totalSessions > 0 ? '<button class="tracker-reset" onclick="resetPractice()">Reset Progress</button>' : ''}`;
}

// ============================================================
// Actions
// ============================================================
function toggleSection(key) { state.expanded[key] = !state.expanded[key]; render(); }
function expandAll() {
  if (!state.condition && state.condition !== 0) return;
  const c = DATA[state.specialty].conditions[state.condition];
  const allActive = SECTION_CONFIG.filter(cfg => c.sections[cfg.key]?.active);
  const allExpanded = allActive.every(cfg => state.expanded[cfg.key]);
  if (allExpanded) state.expanded = {};
  else allActive.forEach(cfg => state.expanded[cfg.key] = true);
  render();
}
function toggleCheck(key) { state.checked[key] = !state.checked[key]; render(); }
function showModal(type) { state.modal = type; render(); }
function closeModal() { state.modal = null; document.querySelectorAll('.modal-overlay').forEach(el => el.remove()); }
function toggleInstall() { state.installOpen = !state.installOpen; render(); }
function logPractice(id) {
  if (!state.practice[id]) state.practice[id] = { count: 0 };
  state.practice[id].count++;
  state.practice[id].lastPracticed = new Date().toISOString();
  savePractice();
  render();
}
function resetPractice() {
  if (confirm('Reset all practice progress? This cannot be undone.')) {
    state.practice = {};
    savePractice();
    render();
  }
}

// Tooltips
function showItemTooltip(e, type, content) {
  e.stopPropagation();
  const r = e.currentTarget.getBoundingClientRect();
  state.tooltip = { type, content: content.replace(/\\n/g,'\n'), x: r.left, y: r.bottom + 8 };
  renderTooltip();
}
function toggleItemTooltip(e, type, content) {
  e.stopPropagation(); e.preventDefault();
  if (state.tooltip) { hideTooltip(); return; }
  showItemTooltip(e, type, content);
}
function showSectionTooltip(e, type, content) {
  const r = e.currentTarget.getBoundingClientRect();
  state.tooltip = { type, content, x: r.left, y: r.bottom + 8 };
  renderTooltip();
}
function toggleSectionTooltip(e, type, content) {
  e.stopPropagation(); e.preventDefault();
  if (state.tooltip) { hideTooltip(); return; }
  showSectionTooltip(e, type, content);
}
function hideTooltip() {
  state.tooltip = null;
  document.querySelectorAll('.tooltip').forEach(el => el.remove());
}
function renderTooltip() {
  document.querySelectorAll('.tooltip').forEach(el => el.remove());
  if (!state.tooltip) return;
  const t = state.tooltip;
  const el = document.createElement('div');
  el.className = 'tooltip';
  const label = t.type === 'synthesis' ? 'üí° Synthesis' : t.type === 'info' ? 'üí° Info' : 'üìö Course';
  const labelClass = t.type === 'course' ? 'course' : 'synthesis';
  
  let contentHtml = esc(t.content).replace(/\\n/g, '<br>');
  // Make URLs clickable
  contentHtml = contentHtml.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>');
  
  el.innerHTML = `<div class="tooltip-label ${labelClass}">${label}</div>${contentHtml}`;
  el.style.left = Math.min(t.x, window.innerWidth - 296) + 'px';
  el.style.top = t.y + 'px';
  document.body.appendChild(el);
  
  // Ensure tooltip stays on screen
  const rect = el.getBoundingClientRect();
  if (rect.bottom > window.innerHeight) {
    el.style.top = (t.y - rect.height - 40) + 'px';
  }
}

// Close tooltip on outside click
document.addEventListener('click', (e) => {
  if (!e.target.closest('.inline-icon') && !e.target.closest('.section-icon') && !e.target.closest('.tooltip')) {
    hideTooltip();
  }
});

function esc(s) { 
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ============================================================
// Init
// ============================================================
loadData();
</script>
</body>
</html>
